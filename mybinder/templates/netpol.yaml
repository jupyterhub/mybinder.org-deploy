{{- if .Values.binderhub.networkPolicy.enabled -}}
{{- $root := . }}
{{- range $component := tuple "singleuser-server" "dind" -}}
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: binder-users-{{ $component }}
  labels:
    app: binderhub
    component: user-netpol
    chart: {{ $root.Chart.Name }}-{{ $root.Chart.Version | replace "+" "_" }}
    release: {{ $root.Release.Name }}
spec:
  podSelector:
    # apply this to both places user code runs: dind and singleuser-server
    # note: Azure NPM doesn't support matchExpressions, so we use a $range
    # matchExpressions is the right thing to use here, though
    # matchExpressions:
    #   - key: component
    #     operator: In
    #     values:
    #       - singleuser-server
    #       - dind
    matchLabels:
      release: {{ $root.Release.Name }}
      component: {{ $component }}
  policyTypes:
    - Ingress
    - Egress
  # block ingress unless explicitly allowed by other policies
  ingress: []
  egress:
    # allow DNS resolution in the cluster
    # it would be nicer to be able to pin this to only the kube-dns service,
    # but we can only seem to select *pods* not *services* as the destination
    - ports:
        - port: 53
          protocol: TCP
        - port: 53
          protocol: UDP
      to:
        - ipBlock:
            cidr: 10.0.0.0/8
    # allow access to the world,
    # but not the cluster
    - ports:
        {{ range $port := $root.Values.binderhub.networkPolicy.egress.tcpPorts }}
        - port: {{ $port }}
          protocol: TCP
        {{ end }}
      to:
      - ipBlock:
          cidr: {{ $root.Values.binderhub.networkPolicy.egress.cidr }}
          except:
            - 169.254.169.254/32
            - 10.0.0.0/8
          {{- range $ipOrCidr := $root.Values.binderhub.networkPolicy.egress.bannedIps }}
            {{- if (contains $ipOrCidr "/") }}
            - {{ $ipOrCidr }}
            {{- else }}
            - {{ $ipOrCidr}}/32
            {{- end }}
          {{- end }}
    # allow https access to the ingress controller
    # (needed to fetch public urls hosted on this cluster,
    # e.g. analytics.mybinder.org)
    - ports:
        - port: 443
          protocol: TCP
      to:
        - podSelector:
            matchLabels:
              app: nginx-ingress
              component: controller
---
{{- end }}
{{- end }}
